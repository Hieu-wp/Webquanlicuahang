<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý hóa đơn</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- CSS riêng -->
  <link href="css/staff-invoice.css" rel="stylesheet">
</head>
<body>

<!-- HEADER STAFF CHUNG -->
<nav class="navbar navbar-expand-lg navbar-dark shadow-sm">
  <div class="container-fluid">

    <a class="navbar-brand" href="/staff-home">Quản lý Winmart</a>

    <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbarNav" class="collapse navbar-collapse justify-content-end">
      <ul class="navbar-nav align-items-lg-center">

        <li class="nav-item">
          <a class="nav-link" href="/staff-home">Trang chủ</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="/staff-customer">Khách hàng</a>
        </li>

        <li class="nav-item">
          <!-- TRANG NÀY: active ở Hóa đơn -->
          <a class="nav-link active" href="/staff-invoice">Hóa đơn</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="/staff-categories">Danh mục</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="/staff-products">Sản phẩm</a>
        </li>

        <!-- Dropdown tài khoản -->
        <li class="nav-item dropdown ms-lg-3">
          <a class="nav-link dropdown-toggle fw-bold" href="#" id="userDropdown"
             role="button" data-bs-toggle="dropdown">
            <span id="welcomeUser">Xin chào, ...</span>
          </a>

          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <a class="dropdown-item" href="/profile">
                <i class="bi bi-person"></i> Xem tài khoản
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="/edit-profile">
                <i class="bi bi-pencil-square"></i> Sửa thông tin
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="/change-password">
                <i class="bi bi-key"></i> Đổi mật khẩu
              </a>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li>
              <a class="dropdown-item text-danger" id="logoutBtn">
                <i class="bi bi-box-arrow-right"></i> Đăng xuất
              </a>
            </li>
          </ul>
        </li>

      </ul>
    </div>

  </div>
</nav>

<div class="main-content">

  <div class="container my-4">
    <h3 class="text-center text-danger mb-4">Quản lí hóa đơn</h3>

    <!-- FILTER BAR -->
    <div class="filter-bar mb-4 p-3 bg-white rounded shadow-sm">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label fw-bold">Mã hóa đơn</label>
          <input type="text" class="form-control" id="filterMaHD" placeholder="'HD1'">
        </div>
        <div class="col-md-3">
          <label class="form-label fw-bold">Ngày lập</label>
          <input type="date" class="form-control" id="filterNgay">
        </div>
        <div class="col-md-3">
          <label class="form-label fw-bold">Trạng thái</label>
          <select class="form-select" id="filterTrangThai">
            <option value="">Tất cả</option>
            <option value="PAID">Đã thanh toán</option>
            <option value="PENDING">Chờ thanh toán</option>
          </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button class="btn btn-success w-100" id="btnCreateInvoice" type="button" onclick="moModalHoaDon()">
            <i class="bi bi-plus-circle"></i> Tạo hóa đơn
          </button>
        </div>
      </div>
    </div>

    <!-- BẢNG HÓA ĐƠN -->
    <div class="table-container">
      <table class="table align-middle table-hover">
        <thead class="table-primary text-center">
        <tr>
          <th class="ps-4">Mã HĐ</th>
          <th>Ngày lập</th>
          <th>Khách hàng</th>
          <th>SL SP</th>
          <th>Tổng tiền</th>
          <th>Trạng thái</th>
          <th class="text-center">Hành động</th>
        </tr>
        </thead>
        <tbody id="invoiceBody" class="text-center"></tbody>
      </table>
    </div>
  </div>

  <!-- MODAL TẠO / SỬA HÓA ĐƠN -->
  <div class="modal fade" id="invoiceEditModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="invoiceModalTitle">Thêm Hóa Đơn Mới</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body bg-light">
          <form id="formHoaDon">
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label">Mã hóa đơn</label>
                <input type="text" class="form-control" id="maHD" value="" readonly>
              </div>
              <div class="col-md-4">
                <label class="form-label">Khách hàng</label>
                <!-- ⭐ Input + gợi ý -->
                <div class="position-relative">
                  <input
                    id="customerSelect"
                    class="form-control"
                    type="text"
                    placeholder="Nhập tên / SĐT / ID khách hàng"
                    autocomplete="off">
                  <ul
                    id="customerSuggest"
                    class="list-group position-absolute w-100"
                    style="z-index: 999; display: none;">
                  </ul>
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Ngày giao dịch</label>
                <input type="date" class="form-control" id="ngayTao">
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">Sản phẩm trong hóa đơn</label>
              <div class="table-responsive">
                <table class="table table-bordered table-sm align-middle mb-2">
                  <thead class="table-danger text-center">
                  <tr>
                    <th>Mã SP</th>
                    <th>Tên SP</th>
                    <th>Số lượng</th>
                    <th>Đơn giá</th>
                    <th>Thành tiền</th>
                    <th>Thao tác</th>
                  </tr>
                  </thead>
                  <tbody id="dsSanPham"></tbody>
                </table>
              </div>
              <button type="button" class="btn btn-success btn-sm" onclick="moModalSanPham()">
                <i class="bi bi-plus-circle"></i> Thêm sản phẩm
              </button>
            </div>

            <div class="card bg-white border-0 shadow-sm p-3 mt-4">
              <label class="form-label fw-semibold">Mã giảm giá</label>
              <div class="d-flex justify-content-between align-items-center bg-light border rounded p-2 mt-2">
                <span class="fw-semibold">Áp dụng mã giảm giá</span>
                <button class="btn btn-outline-warning d-flex align-items-center" type="button"
                        onclick="moModalVoucher()">
                  <i class="bi bi-ticket-perforated me-2"></i> Chọn mã giảm giá
                </button>
              </div>
              <div class="mt-3 text-end">
                <div class="text-muted">Giá gốc: <span id="giaGoc">0</span> đ</div>
                <div class="text-danger">Giảm giá: -<span id="giamGia">0</span> đ</div>
                <div class="fw-bold fs-5">Tổng cộng: <span id="tongTien">0</span> đ</div>
              </div>
            </div>

          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
          <button class="btn btn-primary" type="button" onclick="luuHoaDon()">Lưu hóa đơn</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="productSelectModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="bi bi-box-seam"></i> Chọn sản phẩm</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="input-group mb-3">
            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
            <input type="text" id="timSanPham" class="form-control" placeholder="Tìm sản phẩm theo tên...">
          </div>
          <div class="table-responsive">
            <table class="table align-middle table-hover table-bordered">
              <thead class="table-success text-center">
              <tr>
                <th><input type="checkbox" id="chonTatCa" onclick="chonTatCaSP(this)"></th>
                <th>Ảnh</th>
                <th>Tên sản phẩm</th>
                <th>Giá (₫)</th>
              </tr>
              </thead>
              <tbody id="danhSachSanPham" class="text-center"></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button class="btn btn-success btn-add" type="button" onclick="themSanPhamVaoHoaDon()">
            <i class="bi bi-cart-plus"></i> Thêm vào hóa đơn
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="voucherModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Chọn mã giảm giá</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formVoucher">
            <div class="input-group mb-3">
              <input type="text" class="form-control" id="txtVoucherManual" placeholder="Nhập mã voucher">
              <button class="btn btn-outline-primary" type="button" onclick="apDungVoucherManual()">Áp dụng</button>
            </div>
            <div class="voucher-list">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button class="btn btn-success" type="button" onclick="apDungVoucher()">Áp dụng</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="invoiceDetailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background:#051cef;color:white;">
          <h5 class="modal-title">Chi tiết hóa đơn <span id="modal-maHD"></span></h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body bg-light">
          <div class="row mb-3 text-muted small">
            <div class="col-6">
              <p class="mb-1"><strong>Ngày lập:</strong> <span id="modal-ngay"></span></p>
              <p class="mb-1"><strong>Nhân viên:</strong> <span id="modal-nv"></span></p>
            </div>
            <div class="col-6 text-end">
              <p class="mb-1"><strong>Khách hàng:</strong> <span id="modal-khach"></span></p>
              <p class="mb-1"><strong>SĐT:</strong> <span id="modal-sdt"></span></p>
            </div>
          </div>
          <hr>
          <h6 class="fw-bold text-danger mb-3">Danh sách sản phẩm</h6>
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle">
              <thead class="table-light">
              <tr>
                <th>Sản phẩm</th>
                <th class="text-center">SL</th>
                <th class="text-end">Giá</th>
                <th class="text-end">Thành tiền</th>
              </tr>
              </thead>
              <tbody id="modal-sanpham" class="small"></tbody>
            </table>
          </div>
          <div class="text-end mt-4">
            <div class="text-muted mb-1">
              Giá gốc: <span id="modal-giaGoc">0</span>đ
            </div>
            <div class="text-danger mb-1">
              Giảm giá (<span id="modal-voucherCode">không áp dụng</span>):
              -<span id="modal-giamGia">0</span>đ
            </div>
            <h4 class="text-winmart fw-bold">
              Tổng cộng: <span id="modal-tong">0</span>
            </h4>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
          <button class="btn text-white px-4" style="background:#e63946;" type="button"
                  onclick="printCurrentInvoice()">
            <i class="bi bi-printer"></i> In hóa đơn
          </button>
        </div>
      </div>
    </div>
  </div>
  <div id="alertBoxInvoice">
    <div class="alert-content">
      <div id="alertIconInvoice"></div>
      <p id="alertMessageInvoice"></p>
      <button class="confirm-btn" onclick="closeAlertInvoice()">OK</button>
    </div>
  </div>

</div>

<footer>
  © 2025 - Hệ thống quản lý cửa hàng Winmart | <span id="staffFooterName"></span>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="javascript/staff-invoice.js"></script>
<script src="javascript/footer.js"></script>
</body>
</html>
